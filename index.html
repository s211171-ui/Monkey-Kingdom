<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线钢琴 - 随时随地弹奏美妙音乐</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- GSAP 动画库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1E293B',
                        light: '#F8FAFC',
                        accent: '#8B5CF6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'piano': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'key-white': 'inset 0 1px 0 rgba(255, 255, 255, 0.8), 0 1px 3px rgba(0, 0, 0, 0.2)',
                        'key-black': 'inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 3px rgba(0, 0, 0, 0.4)',
                        'key-white-active': 'inset 0 1px 0 rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2)',
                        'key-black-active': 'inset 0 1px 0 rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.5)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .piano-container {
                position: relative;
                width: 100%;
                height: 300px;
                margin: 0 auto;
                overflow-x: auto;
                overflow-y: hidden;
                padding: 0 10px;
            }
            
            .piano-keys {
                position: relative;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: flex-end;
            }
            
            .key {
                position: relative;
                border-radius: 0 0 5px 5px;
                cursor: pointer;
                transition: all 0.1s ease;
                user-select: none;
                display: flex;
                justify-content: center;
                align-items: flex-end;
                padding-bottom: 10px;
                box-sizing: border-box;
            }
            
            .key-white {
                width: 60px;
                height: 240px;
                background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 100%);
                border: 1px solid #ccc;
                z-index: 1;
                color: #333;
                font-weight: bold;
            }
            
            .key-black {
                width: 36px;
                height: 150px;
                background: linear-gradient(to bottom, #333333 0%, #111111 100%);
                margin: 0 -18px;
                z-index: 2;
                color: #fff;
            }
            
            .key-white.active {
                background: linear-gradient(to bottom, #e0e0e0 0%, #d0d0d0 100%);
                transform: translateY(2px);
                box-shadow: var(--tw-shadow-key-white-active);
            }
            
            .key-black.active {
                background: linear-gradient(to bottom, #222222 0%, #000000 100%);
                transform: translateY(2px);
                box-shadow: var(--tw-shadow-key-black-active);
            }
            
            .key-text {
                opacity: 0.7;
                font-size: 14px;
            }
            
            .key-white .key-text {
                opacity: 0.5;
            }
            
            .key:hover .key-text {
                opacity: 1;
            }
            
            .key:active .key-text {
                opacity: 1;
            }
            
            .control-panel {
                position: absolute;
                top: 10px;
                left: 10px;
                right: 10px;
                z-index: 10;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .control-buttons {
                display: flex;
                gap: 10px;
            }
            
            .control-btn {
                background-color: rgba(255, 255, 255, 0.2);
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                color: white;
                transition: all 0.2s ease;
                backdrop-filter: blur(5px);
            }
            
            .control-btn:hover {
                background-color: rgba(255, 255, 255, 0.3);
                transform: scale(1.05);
            }
            
            .control-btn.active {
                background-color: rgba(59, 130, 246, 0.8);
            }
            
            .volume-control {
                display: flex;
                align-items: center;
                gap: 10px;
                background-color: rgba(255, 255, 255, 0.2);
                padding: 5px 10px;
                border-radius: 20px;
                backdrop-filter: blur(5px);
            }
            
            .volume-slider {
                width: 100px;
                height: 4px;
                -webkit-appearance: none;
                appearance: none;
                background: rgba(255, 255, 255, 0.5);
                outline: none;
                border-radius: 2px;
            }
            
            .volume-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 12px;
                height: 12px;
                background: white;
                border-radius: 50%;
                cursor: pointer;
            }
            
            .volume-slider::-moz-range-thumb {
                width: 12px;
                height: 12px;
                background: white;
                border-radius: 50%;
                cursor: pointer;
                border: none;
            }
            
            .piano-bg {
                background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
                min-height: 100vh;
            }
            
            .header {
                padding: 20px;
                text-align: center;
                color: white;
            }
            
            .header h1 {
                font-size: 2.5rem;
                font-weight: bold;
                margin-bottom: 10px;
            }
            
            .header p {
                font-size: 1.1rem;
                opacity: 0.8;
            }
            
            .footer {
                padding: 20px;
                text-align: center;
                color: white;
                opacity: 0.7;
                font-size: 0.9rem;
            }
            
            .footer a {
                color: #3B82F6;
                text-decoration: none;
            }
            
            .footer a:hover {
                text-decoration: underline;
            }
            
            .keyboard-hints {
                position: absolute;
                bottom: 10px;
                left: 0;
                right: 0;
                display: flex;
                justify-content: center;
                gap: 5px;
                z-index: 5;
                opacity: 0.7;
                font-size: 12px;
                color: white;
            }
            
            .keyboard-hint {
                background-color: rgba(0, 0, 0, 0.5);
                padding: 2px 5px;
                border-radius: 3px;
            }
            
            .song-sheet {
                background-color: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                padding: 20px;
                margin: 20px auto;
                max-width: 800px;
                backdrop-filter: blur(5px);
                color: white;
                display: none;
            }
            
            .song-sheet.active {
                display: block;
            }
            
            .song-title {
                font-size: 1.5rem;
                font-weight: bold;
                margin-bottom: 15px;
                text-align: center;
            }
            
            .song-lyrics {
                font-size: 1rem;
                line-height: 1.6;
                white-space: pre-line;
                text-align: center;
            }
            
            .recorded-notes {
                position: absolute;
                top: 60px;
                left: 10px;
                right: 10px;
                height: 80px;
                overflow: hidden;
                z-index: 5;
                display: flex;
                align-items: center;
                padding: 0 10px;
            }
            
            .recorded-note {
                background-color: rgba(59, 130, 246, 0.7);
                color: white;
                padding: 3px 8px;
                border-radius: 10px;
                margin-right: 5px;
                font-size: 12px;
                animation: fadeInOut 2s ease-in-out;
            }
            
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateY(-10px); }
                10% { opacity: 1; transform: translateY(0); }
                90% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(10px); }
            }
            
            .mobile-hint {
                display: none;
                text-align: center;
                color: white;
                margin: 10px 0;
                font-size: 0.9rem;
                opacity: 0.8;
            }
            
            @media (max-width: 768px) {
                .piano-container {
                    height: 250px;
                }
                
                .key-white {
                    width: 50px;
                    height: 200px;
                }
                
                .key-black {
                    width: 30px;
                    height: 120px;
                    margin: 0 -15px;
                }
                
                .key-text {
                    font-size: 12px;
                }
                
                .header h1 {
                    font-size: 2rem;
                }
                
                .header p {
                    font-size: 1rem;
                }
                
                .keyboard-hints {
                    display: none;
                }
                
                .mobile-hint {
                    display: block;
                }
                
                .volume-slider {
                    width: 70px;
                }
            }
            
            @media (max-width: 480px) {
                .piano-container {
                    height: 200px;
                }
                
                .key-white {
                    width: 40px;
                    height: 160px;
                }
                
                .key-black {
                    width: 24px;
                    height: 100px;
                    margin: 0 -12px;
                }
                
                .key-text {
                    font-size: 10px;
                }
                
                .header h1 {
                    font-size: 1.5rem;
                }
                
                .header p {
                    font-size: 0.9rem;
                }
                
                .control-btn {
                    width: 35px;
                    height: 35px;
                }
                
                .volume-control {
                    padding: 3px 8px;
                }
                
                .volume-slider {
                    width: 50px;
                }
            }
        }
    </style>
</head>
<body class="piano-bg">
    <div class="header">
        <h1>在线钢琴</h1>
        <p>随时随地弹奏美妙音乐</p>
        <div class="mobile-hint">点击或触摸琴键来弹奏钢琴</div>
    </div>
    
    <div class="song-sheet" id="songSheet">
        <div class="song-title" id="songTitle"></div>
        <div class="song-lyrics" id="songLyrics"></div>
    </div>
    
    <div class="piano-container">
        <div class="control-panel">
            <div class="control-buttons">
                <button class="control-btn" id="recordBtn" title="录音">
                    <i class="fa fa-microphone"></i>
                </button>
                <button class="control-btn" id="playBtn" title="播放录音">
                    <i class="fa fa-play"></i>
                </button>
                <button class="control-btn" id="clearBtn" title="清除录音">
                    <i class="fa fa-trash"></i>
                </button>
                <button class="control-btn" id="songBtn" title="简易乐谱">
                    <i class="fa fa-music"></i>
                </button>
            </div>
            
            <div class="volume-control">
                <i class="fa fa-volume-down"></i>
                <input type="range" min="0" max="100" value="80" class="volume-slider" id="volumeSlider">
                <i class="fa fa-volume-up"></i>
            </div>
        </div>
        
        <div class="recorded-notes" id="recordedNotes"></div>
        
        <div class="piano-keys" id="pianoKeys">
            <!-- 钢琴键将通过JavaScript动态生成 -->
        </div>
        
        <div class="keyboard-hints">
            <div class="keyboard-hint">A</div>
            <div class="keyboard-hint">W</div>
            <div class="keyboard-hint">S</div>
            <div class="keyboard-hint">E</div>
            <div class="keyboard-hint">D</div>
            <div class="keyboard-hint">F</div>
            <div class="keyboard-hint">T</div>
            <div class="keyboard-hint">G</div>
            <div class="keyboard-hint">Y</div>
            <div class="keyboard-hint">H</div>
            <div class="keyboard-hint">U</div>
            <div class="keyboard-hint">J</div>
            <div class="keyboard-hint">K</div>
        </div>
    </div>
    
    <div class="footer">
        <p>© 2025 在线钢琴 | 随时随地弹奏美妙音乐</p>
    </div>

    <script>
        // 定义钢琴音符和对应的音频文件
        const pianoNotes = [
            { note: 'C4', type: 'white', key: 'a', audioUrl: 'https://assets.codepen.io/3340260/piano_C4.mp3' },
            { note: 'C#4', type: 'black', key: 'w', audioUrl: 'https://assets.codepen.io/3340260/piano_C%234.mp3' },
            { note: 'D4', type: 'white', key: 's', audioUrl: 'https://assets.codepen.io/3340260/piano_D4.mp3' },
            { note: 'D#4', type: 'black', key: 'e', audioUrl: 'https://assets.codepen.io/3340260/piano_D%234.mp3' },
            { note: 'E4', type: 'white', key: 'd', audioUrl: 'https://assets.codepen.io/3340260/piano_E4.mp3' },
            { note: 'F4', type: 'white', key: 'f', audioUrl: 'https://assets.codepen.io/3340260/piano_F4.mp3' },
            { note: 'F#4', type: 'black', key: 't', audioUrl: 'https://assets.codepen.io/3340260/piano_F%234.mp3' },
            { note: 'G4', type: 'white', key: 'g', audioUrl: 'https://assets.codepen.io/3340260/piano_G4.mp3' },
            { note: 'G#4', type: 'black', key: 'y', audioUrl: 'https://assets.codepen.io/3340260/piano_G%234.mp3' },
            { note: 'A4', type: 'white', key: 'h', audioUrl: 'https://assets.codepen.io/3340260/piano_A4.mp3' },
            { note: 'A#4', type: 'black', key: 'u', audioUrl: 'https://assets.codepen.io/3340260/piano_A%234.mp3' },
            { note: 'B4', type: 'white', key: 'j', audioUrl: 'https://assets.codepen.io/3340260/piano_B4.mp3' },
            { note: 'C5', type: 'white', key: 'k', audioUrl: 'https://assets.codepen.io/3340260/piano_C5.mp3' }
        ];

        // 简易乐谱数据
        const songs = [
            {
                title: "小星星",
                lyrics: `C4 C4 G4 G4 A4 A4 G4
F4 F4 E4 E4 D4 D4 C4
G4 G4 F4 F4 E4 E4 D4
G4 G4 F4 F4 E4 E4 D4
C4 C4 G4 G4 A4 A4 G4
F4 F4 E4 E4 D4 D4 C4`
            },
            {
                title: "欢乐颂",
                lyrics: `E4 E4 F4 G4 G4 F4 E4 D4
C4 C4 D4 E4 E4 D4 D4
E4 E4 F4 G4 G4 F4 E4 D4
C4 C4 D4 E4 D4 C4 C4
D4 D4 E4 C4 D4 E4 F4 E4 C4
D4 E4 F4 E4 D4 C4 D4
E4 E4 F4 G4 G4 F4 E4 D4
C4 C4 D4 E4 D4 C4 C4`
            },
            {
                title: "两只老虎",
                lyrics: `C4 D4 E4 C4 C4 D4 E4 C4
E4 F4 G4 E4 F4 G4
G4 A4 G4 F4 E4 C4
G4 A4 G4 F4 E4 C4
C4 G3 E4 C4 C4 G3 E4 C4`
            }
        ];

        // 当前选中的歌曲索引
        let currentSongIndex = 0;

        // DOM元素
        const pianoKeys = document.getElementById('pianoKeys');
        const recordBtn = document.getElementById('recordBtn');
        const playBtn = document.getElementById('playBtn');
        const clearBtn = document.getElementById('clearBtn');
        const songBtn = document.getElementById('songBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const recordedNotes = document.getElementById('recordedNotes');
        const songSheet = document.getElementById('songSheet');
        const songTitle = document.getElementById('songTitle');
        const songLyrics = document.getElementById('songLyrics');

        // 状态变量
        let isRecording = false;
        let recordedSong = [];
        let isPlaying = false;
        let volume = 0.8;
        let audioContext = null;
        let oscillators = {};

        // 初始化钢琴
        function initPiano() {
            // 创建钢琴键
            pianoNotes.forEach((note, index) => {
                const keyElement = document.createElement('div');
                keyElement.classList.add('key');
                keyElement.classList.add(`key-${note.type}`);
                keyElement.dataset.note = note.note;
                keyElement.dataset.key = note.key;
                
                const keyText = document.createElement('div');
                keyText.classList.add('key-text');
                keyText.textContent = note.note;
                
                keyElement.appendChild(keyText);
                pianoKeys.appendChild(keyElement);
                
                // 添加点击事件
                keyElement.addEventListener('mousedown', () => playNote(note));
                keyElement.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    playNote(note);
                });
            });
            
            // 初始化音频上下文
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
            } catch (e) {
                console.warn('Web Audio API is not supported in this browser');
            }
            
            // 添加键盘事件
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // 添加按钮事件
            recordBtn.addEventListener('click', toggleRecording);
            playBtn.addEventListener('click', playRecording);
            clearBtn.addEventListener('click', clearRecording);
            songBtn.addEventListener('click', toggleSongSheet);
            volumeSlider.addEventListener('input', updateVolume);
        }

        // 播放音符
        function playNote(note) {
            const keyElement = document.querySelector(`[data-note="${note.note}"]`);
            if (keyElement) {
                keyElement.classList.add('active');
                
                // 移除之前的振荡器（如果存在）
                if (oscillators[note.note]) {
                    oscillators[note.note].stop();
                    delete oscillators[note.note];
                }
                
                // 使用音频上下文创建振荡器
                if (audioContext) {
                    try {
                        // 恢复音频上下文（如果被暂停）
                        if (audioContext.state === 'suspended') {
                            audioContext.resume();
                        }
                        
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        // 设置振荡器参数
                        oscillator.type = 'sine';
                        
                        // 根据音符名称计算频率
                        const frequency = getFrequencyFromNote(note.note);
                        oscillator.frequency.value = frequency;
                        
                        // 设置音量
                        gainNode.gain.value = volume;
                        
                        // 连接节点
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        // 开始播放
                        oscillator.start();
                        
                        // 存储振荡器引用
                        oscillators[note.note] = oscillator;
                        
                        // 设置音符衰减
                        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 2);
                        
                        // 2秒后停止播放
                        setTimeout(() => {
                            if (oscillators[note.note]) {
                                oscillators[note.note].stop();
                                delete oscillators[note.note];
                            }
                        }, 2000);
                    } catch (e) {
                        console.error('Error playing note:', e);
                        // 回退到使用音频文件
                        playAudioFile(note.audioUrl);
                    }
                } else {
                    // 如果音频上下文不可用，使用音频文件
                    playAudioFile(note.audioUrl);
                }
                
                // 记录音符（如果正在录音）
                if (isRecording) {
                    recordedSong.push({
                        note: note.note,
                        time: Date.now()
                    });
                    
                    // 显示记录的音符
                    showRecordedNote(note.note);
                }
                
                // 移除活动类
                setTimeout(() => {
                    keyElement.classList.remove('active');
                }, 300);
            }
        }

        // 从音频文件播放音符
        function playAudioFile(url) {
            const audio = new Audio(url);
            audio.volume = volume;
            audio.play().catch(e => console.error('Error playing audio:', e));
        }

        // 根据音符名称计算频率
        function getFrequencyFromNote(note) {
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = parseInt(note.slice(-1));
            const noteName = note.slice(0, -1);
            const noteIndex = notes.indexOf(noteName);
            
            // A4 = 440Hz
            const a4Index = notes.indexOf('A') + 4 * 12;
            const noteIndexFromA4 = noteIndex + octave * 12 - a4Index;
            
            // 计算频率: f = 440 * 2^(n/12)
            return 440 * Math.pow(2, noteIndexFromA4 / 12);
        }

        // 处理键盘按下事件
        function handleKeyDown(e) {
            // 防止默认行为（如滚动）
            if (['a', 'w', 's', 'e', 'd', 'f', 't', 'g', 'y', 'h', 'u', 'j', 'k'].includes(e.key.toLowerCase())) {
                e.preventDefault();
            }
            
            // 查找对应的音符
            const note = pianoNotes.find(n => n.key === e.key.toLowerCase());
            if (note) {
                const keyElement = document.querySelector(`[data-note="${note.note}"]`);
                if (keyElement && !keyElement.classList.contains('active')) {
                    playNote(note);
                }
            }
        }

        // 处理键盘释放事件
        function handleKeyUp(e) {
            const note = pianoNotes.find(n => n.key === e.key.toLowerCase());
            if (note) {
                const keyElement = document.querySelector(`[data-note="${note.note}"]`);
                if (keyElement) {
                    keyElement.classList.remove('active');
                }
            }
        }

        // 切换录音状态
        function toggleRecording() {
            isRecording = !isRecording;
            recordBtn.classList.toggle('active', isRecording);
            
            if (isRecording) {
                recordBtn.innerHTML = '<i class="fa fa-stop"></i>';
                recordBtn.title = '停止录音';
                recordedSong = [];
                recordedNotes.innerHTML = '';
            } else {
                recordBtn.innerHTML = '<i class="fa fa-microphone"></i>';
                recordBtn.title = '录音';
            }
        }

        // 播放录音
        function playRecording() {
            if (recordedSong.length === 0 || isPlaying || isRecording) return;
            
            isPlaying = true;
            playBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
            playBtn.disabled = true;
            
            let index = 0;
            
            function playNextNote() {
                if (index >= recordedSong.length) {
                    isPlaying = false;
                    playBtn.innerHTML = '<i class="fa fa-play"></i>';
                    playBtn.disabled = false;
                    return;
                }
                
                const recordedNote = recordedSong[index];
                const note = pianoNotes.find(n => n.note === recordedNote.note);
                
                if (note) {
                    playNote(note);
                    
                    // 计算下一个音符的延迟
                    let delay = 300; // 默认延迟
                    if (index < recordedSong.length - 1) {
                        const nextTime = recordedSong[index + 1].time;
                        delay = Math.min(Math.max(nextTime - recordedNote.time, 100), 1000);
                    }
                    
                    index++;
                    setTimeout(playNextNote, delay);
                } else {
                    index++;
                    playNextNote();
                }
            }
            
            playNextNote();
        }

        // 清除录音
        function clearRecording() {
            recordedSong = [];
            recordedNotes.innerHTML = '';
        }

        // 显示记录的音符
        function showRecordedNote(note) {
            const noteElement = document.createElement('div');
            noteElement.classList.add('recorded-note');
            noteElement.textContent = note;
            
            recordedNotes.appendChild(noteElement);
            
            // 限制显示的音符数量
            if (recordedNotes.children.length > 10) {
                recordedNotes.removeChild(recordedNotes.firstChild);
            }
            
            // 滚动到最新的音符
            recordedNotes.scrollLeft = recordedNotes.scrollWidth;
        }

        // 切换乐谱显示
        function toggleSongSheet() {
            songSheet.classList.toggle('active');
            songBtn.classList.toggle('active', songSheet.classList.contains('active'));
            
            if (songSheet.classList.contains('active')) {
                // 显示当前歌曲
                const song = songs[currentSongIndex];
                songTitle.textContent = song.title;
                songLyrics.textContent = song.lyrics;
                
                // 点击歌曲标题切换歌曲
                songTitle.addEventListener('click', function() {
                    currentSongIndex = (currentSongIndex + 1) % songs.length;
                    const nextSong = songs[currentSongIndex];
                    songTitle.textContent = nextSong.title;
                    songLyrics.textContent = nextSong.lyrics;
                    
                    // 添加切换动画
                    gsap.from(songTitle, { opacity: 0, y: -10, duration: 0.3 });
                    gsap.from(songLyrics, { opacity: 0, y: 10, duration: 0.3, delay: 0.1 });
                });
            }
        }

        // 更新音量
        function updateVolume() {
            volume = volumeSlider.value / 100;
        }

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            initPiano();
            
            // 添加页面加载动画
            gsap.from('.header', { opacity: 0, y: -20, duration: 0.8 });
            gsap.from('.piano-container', { opacity: 0, y: 20, duration: 0.8, delay: 0.2 });
            gsap.from('.footer', { opacity: 0, y: 20, duration: 0.8, delay: 0.4 });
            
            // 为钢琴键添加动画
            const keys = document.querySelectorAll('.key');
            gsap.from(keys, {
                opacity: 0,
                y: 20,
                duration: 0.5,
                stagger: 0.03,
                delay: 0.6
            });
        });
    </script>
</body>
</html>
